Шпаргалка: IaC, Terraform и Ansible с определениями


---

1. IaC (Infrastructure as Code)

IaC (Инфраструктура как код) — это подход, при котором инфраструктура (сервера, сети, базы и т.д.) описывается в виде текста (кода) и управляется как программный проект.
IaC делает возможным:

автоматизацию настройки серверов;

быструю сборку окружений;

контроль версий через Git.


Типы IaC:

Декларативный — ты описываешь что нужно получить (например, Terraform).

Императивный — ты описываешь что делать шаг за шагом (например, Ansible).



---

2. Terraform (HashiCorp)

Terraform — это декларативный инструмент IaC, позволяющий описывать и управлять инфраструктурой с помощью HCL (HashiCorp Configuration Language).

Ключевые понятия:

Provider — плагин для работы с платформами (AWS, GCP, Docker, etc).

Resource — объект инфраструктуры (например, EC2 instance).

Variable — переменная для переиспользования значений.

Output — вывод значений после apply.

State (tfstate) — JSON-файл, где хранится текущее состояние инфраструктуры.

Backend — хранилище состояния (локальное, S3, etc).

Module — переиспользуемый блок конфигурации.

Locking — механизм защиты от параллельных изменений состояния.


Основные команды:

terraform init — инициализация.

terraform plan — показывает план изменений.

terraform apply — применяет изменения.

terraform destroy — удаляет ресурсы.

terraform import — подключение к существующим ресурсам.



---

3. Ansible (от Red Hat)

Ansible — это инструмент управления конфигурацией и автоматизации задач (императивный IaC), использующий YAML-файлы (playbooks).

Ключевые понятия:

Inventory — список управляемых серверов.

Playbook — набор задач в YAML для настройки серверов.

Task — одно действие (например, установка пакета).

Role — структурированная форма Playbook’ов (модули).

Handler — задача, выполняемая по событию (например, перезапуск nginx).

Facts — автоматически собранная информация о хосте.

Modules — встроенные команды (например, apt, yum, service).

Templates — Jinja2-шаблоны для конфигураций.

Vault — шифрование секретов.


Основные команды:

ansible all -m ping — проверка связи.

ansible-playbook site.yml — запуск сценария.

ansible-vault encrypt vars.yml — шифрование файла.



---

4. Совместное использование

Сценарий:

1. Terraform создает VM.


2. terraform output возвращает IP-адреса.


3. Ansible подключается к ним по SSH и настраивает окружение.




---

5. Дополнительно

Immutable Infrastructure

Иммутабельная инфраструктура — инфраструктура, которая не модифицируется, а пересоздается при любом изменении. Пример: образ AMI через Packer + Terraform.

Mutable Infrastructure

Мутатабельная инфраструктура — текущая инфраструктура изменяется «на месте» (например, с помощью Ansible).

Idempotency (Идемпотентность)

Идемпотентные операции — те, которые при многократном запуске дают один и тот же результат (без повторного применения изменений).

Secrets Management (Управление секретами)

Ansible Vault — встроенное шифрование файлов.

Terraform — можно использовать переменные окружения, HashiCorp Vault, AWS SSM Parameter Store.



---

6. Примеры

Terraform:

provider "aws" {
  region = "us-east-1"
}

resource "aws_instance" "example" {
  ami           = "ami-123"
  instance_type = "t2.micro"
}

Ansible:

- name: Установка nginx
  hosts: web
  become: yes
  tasks:
    - name: Установить nginx
      apt:
        name: nginx
        state: present


---

7. Best Practices

Всегда использовать terraform plan.

Разделяй инфраструктуру по окружениям (dev/stage/prod).

Используй модули в Terraform и роли в Ansible.

Не храни секреты в открытом виде.

Используй Git для контроля версий.

Автоматизируй запуск через CI/CD.